<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>추천 결과 — 카드 보기</title>
  <style>
    :root{ --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --accent:#2563eb; }
    *{ box-sizing:border-box } body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:linear-gradient(#fff,var(--bg)) }
    .container{ min-height:100svh; display:grid; place-items:center; padding:20px }
    .card{ width:min(100%,1080px); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(2,6,23,.06) }
    .card-header{ padding:20px 24px; border-bottom:1px solid var(--border) }
    .title{ font-size:clamp(20px,2.2vw,28px); font-weight:800; margin:0 0 4px }
    .subtitle{ margin:0; color:var(--muted); font-size:14px }
    .card-body{ padding:20px 24px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center }
    .badge{ display:inline-block; background:#eef2ff; color:#1e293b; padding:8px 12px; border-radius:999px; font-weight:700 }
    .ghost{ padding:10px 14px; border-radius:10px; background:#fff; border:1px solid var(--border); cursor:pointer; text-decoration:none; color:inherit }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .grid{ display:grid; gap:16px; grid-template-columns:1fr }
    .bcard{ display:grid; grid-template-columns: 340px 1fr; gap:18px; border:1px solid var(--border); border-radius:14px; padding:16px; background:#fff }
    @media (max-width:860px){ .bcard{ grid-template-columns: 1fr; } }
    .imgbox{ width:100%; aspect-ratio:3/4; background:#f1f5f9; border:1px dashed #cbd5e1; border-radius:10px; display:grid; place-items:center; overflow:hidden }
    .imgbox img{ width:100%; height:100%; object-fit:cover }
    .title2{ font-size:20px; font-weight:800; margin:0 0 8px }
    .grid2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px 14px }
    .field{ border:1px solid var(--border); border-radius:8px; padding:10px 12px; background:#fff }
    .label{ font-size:12px; color:#64748b; margin-bottom:4px }
    .value{ font-weight:700 }
    .small{ color:var(--muted); font-size:12px }
    .hr{ height:1px; background:var(--border); margin:18px 0 }
  </style>

  <!-- SSE 리스너: data.js 버전 바뀌면 자동 재로딩 -->
  <script>
    (function(){
      const sse = new EventSource('/events');
      let current = null;
      sse.onmessage = (e)=>{
        try{
          const {version} = JSON.parse(e.data||'{}');
          if(current===null){ current=version; return; }
          if(version && version!==current){
            current = version;
            const old = document.querySelector('script[data-shared="data"]');
            const s = document.createElement('script');
            s.src = '/assets/data.js?v=' + Date.now();
            s.dataset.shared = 'data';
            s.onload = ()=>{
              if(window.DATA && !window.CATALOG) window.CATALOG = window.DATA;
              window.dispatchEvent(new Event('data:updated'));
            };
            if(old) old.remove();
            document.head.appendChild(s);
          }
        }catch(_){}
      };
    })();
  </script>
  <!-- 공유 데이터 최초 로드(+호환 shim) -->
  <script data-shared="data" src="/assets/data.js"></script>
  <script>if(window.DATA && !window.CATALOG) window.CATALOG = window.DATA;</script>
</head>
<body>
  <div class="container">
    <div class="card" role="region" aria-label="추천 결과 카드">
      <div class="card-header">
        <h1 class="title">도서 추천 — 카드 보기</h1>
        <p class="subtitle" id="sel"></p>
      </div>
      <div class="card-body">
        <div class="row toolbar">
          <div style="display:flex; gap:8px">
            <a class="ghost" id="back-list" href="results.html">목록 보기</a>
            <a class="ghost" id="back-filters" href="filters.html">선택 다시 하기</a>
          </div>
          <span class="badge" id="grade-badge">?학년</span>
        </div>
        <div class="hr"></div>
        <div class="small" id="status">불러오는 중...</div>
        <div class="grid" id="wrap"></div>
      </div>
    </div>
  </div>

  <script>
    const p    = new URLSearchParams(location.search);
    const grade = p.get('grade');
    const aud   = (p.get('aud') || '').split(',').filter(Boolean);
    const sub   = (p.get('sub') || '').split(',').filter(Boolean);

    document.getElementById('grade-badge').textContent = (grade || '?') + '학년';
    document.getElementById('sel').textContent =
      `학년: ${grade ?? '(미선택)'} · 자료유형: ${aud.join(', ') || '(전체)'} · 대분류: ${sub.join(', ') || '(전체)'}`;

    const qs = (() => {
      const q = new URLSearchParams();
      if (grade) q.set('grade', grade);
      if (aud.length) q.set('aud', aud.join(','));
      if (sub.length) q.set('sub', sub.join(','));
      return '?' + q.toString();
    })();
    document.getElementById('back-list').href   = 'results.html' + qs;
    document.getElementById('back-filters').href= 'filters.html' + (grade ? ('?grade='+encodeURIComponent(grade)) : '');

    function scoreOf(item){
      const gcol = grade ? `${grade}학년` : null;
      if (gcol && item[gcol] != null) return Number(item[gcol]) || 0;
      if (item["대출빈도"] != null)   return Number(item["대출빈도"]) || 0;
      if (item["빈도"] != null)       return Number(item["빈도"]) || 0;
      return 0;
    }

    function guessImage(regno){
      if(!regno) return null;
      const exts = ['jpg','png','jpeg'];
      return exts.map(e => `images/${regno}.${e}`);
    }

    function render(){
      if(!Array.isArray(window.CATALOG)){ return; }
      const status = document.getElementById('status');
      const wrap = document.getElementById('wrap');

      let list = window.CATALOG.slice();
      if (aud.length) list = list.filter(x => aud.includes(String(x["자료유형"]||"").trim()));
      if (sub.length) list = list.filter(x => sub.includes(String(x["대분류"]||"").trim()));

      list.forEach(x => x["점수"] = scoreOf(x));
      list.sort((a,b) => b["점수"] - a["점수"] || String(a["도서명"]||"").localeCompare(String(b["도서명"]||"")));
      const top = list.slice(0,10);

      status.textContent = `총 ${list.length}권 중 상위 10권을 카드로 표시합니다.`;
      wrap.innerHTML = '';

      if(top.length === 0){
        wrap.innerHTML = '<p class="small">조건에 맞는 도서가 없습니다.</p>';
        return;
      }

      top.forEach(item => {
        const regno = item["등록번호"] || "";
        const imgCandidates = guessImage(regno) || [];

        const el = document.createElement('div');
        el.className = 'bcard';

        const imgBox = document.createElement('div');
        imgBox.className = 'imgbox';

        const img = document.createElement('img');
        img.alt = regno ? `표지: ${regno}` : '표지';
        let idx = 0;
        function tryNext(){
          if(idx < imgCandidates.length){
            img.src = imgCandidates[idx++];
          }else{
            imgBox.innerHTML = '<div style="font-size:14px; color:#94a3b8">이미지 없음</div>';
          }
        }
        img.onerror = tryNext;
        img.onload = () => {};
        tryNext();
        imgBox.appendChild(img);

        const meta = document.createElement('div');
        const h = document.createElement('h2');
        h.className = 'title2';
        h.textContent = item["도서명"] || "(제목 없음)";

        const grid2 = document.createElement('div');
        grid2.className = 'grid2';
        function field(label, value){
          const box = document.createElement('div');
          box.className = 'field';
          box.innerHTML = `<div class="label">${label}</div><div class="value">${value || '-'}</div>`;
          return box;
        }
        grid2.appendChild(field('청구기호', item["청구기호"] || ""));
        grid2.appendChild(field('총서명', item["총서명"] || ""));
        grid2.appendChild(field('저자명', item["저자명"] || ""));
        grid2.appendChild(field('출판사', item["출판사"] || ""));
        grid2.appendChild(field('대분류', item["대분류"] || ""));
        grid2.appendChild(field('자료유형', item["자료유형"] || ""));

        const small = document.createElement('div');
        small.className = 'small';
        small.textContent = (item["등록번호"] ? `등록번호: ${item["등록번호"]} · ` : '') + `점수: ${item["점수"]}`;

        meta.appendChild(h);
        meta.appendChild(grid2);
        meta.appendChild(document.createElement('div')).className='hr';
        meta.appendChild(small);

        el.appendChild(imgBox);
        el.appendChild(meta);
        wrap.appendChild(el);
      });
    }

    render();
    window.addEventListener('data:updated', render);
  </script>
</body>
</html>
